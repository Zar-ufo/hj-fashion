// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// Categories for products
model Category {
  id            String     @id @default(cuid())
  name          String
  slug          String     @unique
  description   String?
  image_url     String?
  parent_id     String?
  parent        Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children      Category[] @relation("CategoryHierarchy")
  is_occasion   Boolean    @default(false)
  display_order Int        @default(0)
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  products      Product[]

  @@map("categories")
}

// Products in the store
model Product {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique
  description       String
  price             Float
  original_price    Float?
  images            String[]
  is_featured       Boolean     @default(false)
  ratings           Float       @default(0)
  sizes             String[]
  fabric            String?
  color             String?
  care_instructions String?
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt
  category_id       String
  category          Category    @relation(fields: [category_id], references: [id])
  order_items       OrderItem[]

  @@map("products")
}

// Users for authentication
model User {
  id                        String                   @id @default(cuid())
  email                     String                   @unique
  password_hash             String
  first_name                String?
  last_name                 String?
  phone                     String?
  address                   String?
  city                      String?
  postal_code               String?
  country                   String?
  role                      Role                     @default(CUSTOMER)
  is_blocked                Boolean                  @default(false)
  email_verified            Boolean                  @default(false)
  email_verified_at         DateTime?
  created_at                DateTime                 @default(now())
  updated_at                DateTime                 @updatedAt
  orders                    Order[]
  password_reset_tokens     PasswordResetToken[]
  email_verification_tokens EmailVerificationToken[]
  sessions                  Session[]

  @@map("users")
}

enum Role {
  CUSTOMER
  ADMIN
}

// Events/Promotions for discounts
model Event {
  id               String         @id @default(cuid())
  name             String
  description      String?
  image_url        String?
  discount_percent Float
  start_date       DateTime
  end_date         DateTime
  is_active        Boolean        @default(true)
  is_featured      Boolean        @default(false)
  applies_to       EventAppliesTo @default(ALL)
  category_id      String?
  min_price        Float?
  max_price        Float?
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt

  @@map("events")
}

enum EventAppliesTo {
  ALL
  CATEGORY
  PRICE_RANGE
}

// Orders placed by users
model Order {
  id                   String        @id @default(cuid())
  user_id              String
  user                 User          @relation(fields: [user_id], references: [id])
  status               OrderStatus   @default(PENDING)
  total                Float
  shipping_address     String
  shipping_city        String
  shipping_postal_code String
  shipping_country     String
  payment_method       String?
  payment_status       PaymentStatus @default(PENDING)
  notes                String?
  created_at           DateTime      @default(now())
  updated_at           DateTime      @updatedAt
  items                OrderItem[]

  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Items in an order
model OrderItem {
  id         String   @id @default(cuid())
  order_id   String
  order      Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product_id String
  product    Product  @relation(fields: [product_id], references: [id])
  quantity   Int
  size       String
  price      Float
  created_at DateTime @default(now())

  @@map("order_items")
}

// Password reset tokens
model PasswordResetToken {
  id         String   @id @default(cuid())
  token      String   @unique
  user_id    String
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("password_reset_tokens")
}

// Email verification tokens
model EmailVerificationToken {
  id         String   @id @default(cuid())
  token      String   @unique
  user_id    String
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())

  @@map("email_verification_tokens")
}

// Session tokens for JWT refresh
model Session {
  id            String   @id @default(cuid())
  session_token String   @unique
  user_id       String
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  expires_at    DateTime
  created_at    DateTime @default(now())

  @@map("sessions")
}
